---
title: åŸºäºŽcontainerdéƒ¨ç½²K8S
date: 2024-3-6 09:26:26
categories: 
- [K8S]
tags: 
- k8s
---

## é›¶ã€ çŽ¯å¢ƒä»‹ç»

  - **HW:** 2c2g  20GB
  - **OS:** Rocky Linux 9.2
  - **Master:** 192.168.128.200 
  - **Node1:**  192.168.128.204 
  - **Node2:**  192.168.128.205 


## ä¸€ã€ åŸºç¡€çŽ¯å¢ƒ

  - ä¸€å°æˆ–å¤šå°æœåŠ¡å™¨
  - å†…å­˜2GBæˆ–æ›´å¤šï¼ŒCPU2æ ¸æˆ–æ›´å¤šï¼Œç¡¬ç›˜30GBæˆ–æ›´å¤š
  - æ‰€æœ‰æœºå™¨ä¹‹é—´ç½‘ç»œäº’é€š
  - å¯ä»¥è®¿é—®å¤–ç½‘ï¼Œéœ€è¦æ‹‰å–é•œåƒ
  - ç¦æ­¢swapåˆ†åŒº

### 1.1 ç¦æ­¢ SWAP åˆ†åŒº

  ç¼–è¾‘é…ç½®æ–‡ä»¶: ```/etc/fstab``` æ³¨é‡Šç›¸å…³åˆ†åŒº, é‡å¯ç³»ç»Ÿ


### 1.2 å…³é—­é˜²ç«å¢™

  - ä¸‰å°æœåŠ¡å™¨éƒ½éœ€é…ç½®
    ``` systemctl stop firewalld iptables ```
    ``` systemctl disable firewalld iptables ```

### 1.3 å…³é—­ SeLinux
  - ä¸‰å°æœåŠ¡å™¨éƒ½éœ€é…ç½®
    ``` sed -i 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config ```

### 1.4 é…ç½®ä¸»æœºå

  - ``` hostnamectl set-hostname k8s-master ```

  | ä¸»æœº| ip |
  |---|---|
  |k8s-master|192.168.128.200|
  |k8s-node1|192.168.128.204|
  |k8s-node2|192.168.128.205|

### 1.5 é…ç½®è§£æž
  - ä¸‰å°æœåŠ¡å™¨éƒ½éœ€é…ç½®

    ``` shell
    cat >> /etc/hosts << EOF
    192.168.128.200 k8s-master
    192.168.128.204 k8s-node1
    192.168.128.205 k8s-node2
    EOF
    ```

### 1.6 é…ç½®æ—¶é—´åŒæ­¥
  - ä¸‰å°æœåŠ¡å™¨éƒ½éœ€é…ç½®
    ``` systemctl enable chronyd --now ```

### 1.7 é…ç½®ipvsè´Ÿè½½å‡è¡¡
  - master èŠ‚ç‚¹é…ç½®
    **è·¯å¾„ä¸åŒäºŽCentOS7  çš„ ```/etc/sysconfig/modules```**

      ``` shell
      # å®‰è£…ç›¸å…³è½¯ä»¶åŒ…
      yum install ipset ipvsadm
    
      # å¼€å¯ ip_vs é…ç½®æ–‡ä»¶
      cat > /etc/modules-load.d/ipvs.conf <<EOF
      ip_vs
      ip_vs_rr
      ip_vs_wrr
      ip_vs_sh
      nf_conntrack_ipv4
      EOF
    
      # å†…æ ¸é‡æ–°åŠ è½½
      systemctl restart systemd-modules-load.service
    
      # éªŒè¯ç›¸å…³æ¨¡å—æ˜¯å¦åŠ è½½
      [root@k8s-master]# lsmod | grep ip_vs
      ip_vs_sh               16384  0
      ip_vs_wrr              16384  0
      ip_vs_rr               16384  0
      ip_vs                 233472  6 ip_vs_rr,ip_vs_sh,ip_vs_wrr
      nf_conntrack          212992  3 nf_nat,nft_ct,ip_vs
      nf_defrag_ipv6         24576  2 nf_conntrack,ip_vs
      libcrc32c              16384  5 nf_conntrack,nf_nat,nf_tables,xfs,ip_vs
      ```

### 1.8 å¼€å¯ç½‘ç»œè½¬å‘å’Œæ¡¥æŽ¥
  - ä¸‰å°æœåŠ¡å™¨éƒ½éœ€é…ç½®
    ``` shell
    cat >> /etc/sysctl.conf << EOF
    net.ipv4.ip_forward = 1
    net.bridge.bridge-nf-call-iptables = 1
    net.bridge.bridge-nf-call-ip6tables = 1
    EOF
    ```
    ``` sysctl -p ```

### 1.9 ä¿®æ”¹æº
  - ä¸‰å°æœåŠ¡å™¨éƒ½éœ€é…ç½®
``` shell
sudo sed -e 's|^mirrorlist=|#mirrorlist=|g' \
          -e 's|^#baseurl=http://dl.rockylinux.org/$contentdir|baseurl=https://mirror.nju.edu.cn/rocky|g' \
          -i.bak \
          /etc/yum.repos.d/rocky-extras.repo \
          /etc/yum.repos.d/rocky.repo
```


## äºŒã€ containerd éƒ¨ç½² (äºŒè¿›åˆ¶)

  - ä¸‰å°æœåŠ¡å™¨éƒ½éœ€è¦éƒ¨ç½²


### 2.1 ä¸‹è½½

  ``` https://github.com/containerd/containerd/releases ```

### 2.2 è§£åŽ‹ï¼ˆnot follow FHSï¼‰

  ``` tar xzvf containerd-1.6.2-linux-amd64.tar.gz -C /usr/local/containerd ```

### 2.3 systemdç®¡ç†

  ``` bash
  [Unit]
  Description=containerd container runtime
  Documentation=https://containerd.io
  After=network.target local-fs.target
  
  [Service]
  ExecStartPre=-/sbin/modprobe overlay
  ExecStart=/usr/local/containerd/bin/containerd
  
  Type=notify
  Delegate=yes
  KillMode=process
  Restart=always
  RestartSec=5
  
  LimitNPROC=infinity
  LimitCORE=infinity
  
  TasksMax=infinity
  OOMScoreAdjust=-999
  
  [Install]
  WantedBy=multi-user.target
  ```

  ``` systemctl daemon-reload ```
  ``` systemctl enable containerd --now ```
  ``` echo 'PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/containerd/bin"' > /etc/environment ```


### 2.4 å¯èƒ½é‡åˆ°çš„é—®é¢˜

é—®é¢˜ï¼š ```containerd.service: Main process exited, code=exited, status=2/INVALIDARGUMENT```
è§£å†³ï¼š ```rm -rf /var/lib/containerd```


### 2.5 å®‰è£… runc

  ``` https://github.com/containernetworking/plugins/releases ```
  ``` mkdir -p /opt/cni/bin ```
  ``` tar -xzvf  cni-plugins-linux-amd64-v1.1.1.tgz -C /opt/cni/bin ```


## ä¸‰ã€ containerd å®‰è£… (yum)


containerdçš„å®˜æ–¹yumæºæ˜¯ç”±dockeråŽ»ç»´æŠ¤çš„  ðŸ˜‚ðŸ˜‚ðŸ˜‚ðŸ˜‚(â—'â—¡'â—)(â—'â—¡'â—)(â—'â—¡'â—)
  ``` yum install -y yum-utils ```
  ``` yum-config-manager --add-repo https://download.docker.com/linux/rhel/docker-ce.repo ```
  ``` yum install containerd.io ```



## å››ã€ é…ç½® cotainerd

### 4.1 ç”Ÿæˆé…ç½®æ–‡ä»¶

  ``` containerd config default > /etc/containerd/config.toml ```





















## äºŒã€ å®‰è£… k8s ç»„ä»¶

### 2.1 é…ç½®æº
- ä¸‰å°æœåŠ¡å™¨éƒ½éœ€è¦æ“ä½œ
``` shell
cat >  /etc/yum.repos.d/kubernetes.repo << EOF
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.28/rpm/
enabled=1
gpgcheck=1
gpgkey=https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.28/rpm/repodata/repomd.xml.key
EOF
```

### 2.2 å®‰è£… K8S è½¯ä»¶åŒ…
- ä¸‰å°æœåŠ¡å™¨éƒ½éœ€è¦æ“ä½œ
``` yum install kubeadm kubelet kubectl kubernetes-cni cri-tools ```

### 2.3 é…ç½® cri
- ä¸‰å°æœåŠ¡å™¨éƒ½éœ€è¦æ“ä½œ
``` shell
cat > /etc/crictl.yaml << EOF
runtime-endpoint: unix:///run/containerd/containerd.sock
image-endpoint: unix:///run/containerd/containerd.sock
timeout: 10
debug: true
pull-image-on-create: false
disable-pull-on-run: false
EOF
```