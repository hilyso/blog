---
title: 常用LVM操作
date: 2022-03-03 17:30:08
categories: 
- [Linux]
- [CentOS]
- [Ubuntu]
tags: LVM
---


> LVM是逻辑卷管理（Logical Volume Manager）的简称，它是Linux环境下对磁盘分区进行管理的一种机制。LVM通过在硬盘和文件系统之间添加一个逻辑层，来为文件系统屏蔽下层硬盘分区布局，提高硬盘分区管理的灵活性，


## 名词解释
- ```物理存储介质（The physical media）```：指系统的物理存储设备，如硬盘，系统中为```/dev/hda```、```/dev/sda```、```/dev/vda```等等，是存储系统最低层的存储单元。

```{% note info %}```
NOTE:  ``` /dev/sda``` 和 ```/dev/sda1```是有区别的。 ```/dev/sda``` 表示整个```sda```整个硬盘, ```/dev/sda1```表示的是硬盘上的一个分区。
好比你的电脑是256的固态, 然后划分成C, D两个盘。 sda指固态, sda1指C盘, sda2指D盘。
```{% endnote %}```

- ```PV: 物理卷（Physical Volume）```：指硬盘分区或从逻辑上与磁盘分区具有同样功能的设备(如RAID), 是LVM的基本存储逻辑块。物理卷包括一个特殊的标签，该标签默认存放在第二个 512 字节扇区，但也可以将标签放在最开始的四个扇区之一。该标签包含物理卷的随机唯一识别符（UUID），记录块设备的大小和LVM元数据在设备中的存储位置。

- ```VG: 卷组（Volume Group）```：由物理卷组成，屏蔽了底层物理卷细节。可在卷组上创建一个或多个逻辑卷且不用考虑具体的物理卷信息。

- ```LV: 逻辑卷（Logical Volume）```：卷组不能直接用，需要划分成逻辑卷才能使用。逻辑卷可以格式化成不同的文件系统，挂载后直接使用。

- ```PE: 物理块（Physical Extent）```：物理卷以大小相等的“块”为单位存储，块的大小与卷组中逻辑卷块的大小相同。

- ```LE: 逻辑块（Logical Extent，）```：逻辑卷以“块”为单位存储，在一卷组中的所有逻辑卷的块大小是相同的

![lvm图解](/images/004.lvm.md.01.png)

使用LVM管理硬盘的基本过程如下：

- 1.将硬盘创建为物理卷
- 2.将多个物理卷组合成卷组
- 3.在卷组中创建逻辑卷
- 4.在逻辑卷之上创建文件系统
通过LVM管理硬盘之后，文件系统不再受限于硬盘的大小，可以分布在多个硬盘上，也可以动态扩容。


## 情形一: 根目录扩容(常见于CentOS)

- 0: 格式化磁盘并修改分区格式 
``` fdisk /dev/sdb [n, p, 1, size, t, 8e, w]```

- 1: 创建 PV
 ``` pvcreate /dev/sdb```

- 2: 扩展 VG
 ``` vgextend centos /dev/sdb1```

- 3: 扩展LV
 ``` lvextend -l +100%FREE /dev/centos/root```

- 4: 刷新
 ``` xfs_growfs /dev/centos/root```

 ## 情形二: 根目录扩容(常见于Ubuntu)

- 0: 格式化磁盘并修改分区格式 
``` fdisk /dev/sdb [n, p, 1, size, t, 8e, w]```

- 1: 创建 PV
 ``` pvcreate /dev/sdb```

- 2: 扩展 VG
 ``` vgextend ubuntu-vg /dev/sdb1```

- 3: 扩展LV
 ``` lvextend -l +100%FREE /dev/ubuntu-vg/ubuntu-lv```

- 4: 刷新
 ``` resize2fs /dev/ubuntu-vg/ubuntu-lv```

```{% note info %}NOTE:```
P.S 如果碰到 xfs 提示 xfs_growfs: /dev/centos/root is not a mounted XFS filesystem
因为不同的文件格式刷新的方式不同。
对于 xfs : ```xfs_growfs + 挂载点```
对于 ext2/3/4: ```resize2fs + 挂载点```
```{% endnote %}```

- 确认文件系统格式和挂载点
``` df -Thl```
![df -Thl](/images/004.lvm.md.02.png)
``` lsblk ```
![lsblk](/images/004.lvm.md.03.png)



## 情形三: 一块磁盘做成lvm单独挂载某个目录

将新磁盘分成两个区,一个挂载/data; 一个挂载/var/lib/docker

![图](/images/004.lvm.md.04.png)

``` yaml

# 创建 pv
pvcreate /dev/sdb1   

# 创建 vg0
vgcreate vg0 /dev/sdb1


# 创建 lv0 和 lv1
lvcreate  -l 50%FREE -n lv0 vg0

lvcreate  -l 100%FREE -n lv1 vg0

# 格式化
mkfs.xfs /dev/vg0/lv0
mkfs.xfs /dev/vg0/lv0

# 挂载
echo "/dev/vg0/lv0 /data/  xfs  defaults   0 0"  >> /etc/fstab
echo "/dev/vg0/lv1 /var/lib/docker  xfs  defaults   0 0"  >> /etc/fstab

```